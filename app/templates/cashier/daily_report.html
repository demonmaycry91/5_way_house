{% extends "base.html" %}
{# 從 macros.html 檔案中匯入我們自訂的 page_header 宏，方便我們建立標準化的頁首 #}
{% from "macros.html" import page_header with context %}

{# [修改點] 設定瀏覽器分頁的標題，使用從後端傳來的 day 物件中的據點名稱 (day.location.name) #}
{% block title %}每日報表 - {{ day.location.name }}{% endblock %}

{% block content %}
{# --- 頁面標題區塊 --- #}
{# 這裡使用一個 if/else 判斷式來決定頁首的樣式 #}
{# 如果本日帳務尚未歸檔 (status 不是 'CLOSED')，則顯示一個可以返回儀表板的按鈕 #}
{% if day.status != 'CLOSED' %}
    {{ page_header(
        title='每日報表',
        subtitle='據點：' ~ day.location.name ~ ' | 日期：' ~ day.date.strftime('%Y-%m-%d'),
        button_url=url_for('cashier.dashboard'),
        button_text='返回儀表板'
    ) }}
{# 如果本日帳務已歸檔，則只顯示標題和副標題，不顯示按鈕 #}
{% else %}
    {{ page_header(
        title='每日報表',
        subtitle='據點：' ~ day.location.name ~ ' | 日期：' ~ day.date.strftime('%Y-%m-%d')
    ) }}
{% endif %}

{# --- Flash 訊息顯示區塊 --- #}
{# 這是 Flask 的標準作法，用來顯示從後端透過 flash() 函式傳來的臨時訊息 (例如 "操作成功" 或 "錯誤") #}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

{# --- 帳務核對卡片 --- #}
<div class="card">
    <div class="card-header fs-5">帳務核對</div>
    <div class="card-body">
        {# 使用 table-responsive div 包裹表格，確保在手機等小螢幕上可以水平捲動，不會破壞版面 #}
        <div class="table-responsive">
            <table class="table table-borderless fs-5 mb-0">
                <tbody>
                    <tr>
                        <td>開店準備金</td>
                        <td class="text-end" style="width: 1rem;">$</td>
                        {# 使用 Jinja2 的 filter 來格式化數字：round(2) 四捨五入到小數點後兩位，int 轉為整數 #}
                        <td class="text-end" style="width: 10ch;">{{ day.opening_cash | round(2) | int }}</td>
                    </tr>
                    <tr>
                        <td>本日銷售總額</td>
                        <td class="text-end" style="width: 1rem;">$</td>
                        <td class="text-end" style="width: 10ch;">{{ day.total_sales | round(2) | int }}</td>
                    </tr>
                    <tr class="fw-bold">
                        <td>帳面總額 (A)</td>
                        <td class="text-end fw-bold" style="width: 1rem;">$</td>
                        <td class="text-end fw-bold" style="width: 10ch;">{{ 帳面總額 | round(2) | int }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">盤點現金合計 (B)</td>
                        <td class="text-end fw-bold" style="width: 1rem;">$</td>
                        <td class="text-end fw-bold" style="width: 10ch;">{{ day.closing_cash | round(2) | int }}
                        </td>
                    </tr>
                    <tr class="fw-bolder">
                        {# 根據「帳差」是正數、負數還是零，動態地為文字套用不同的顏色 (text-danger, text-primary, text-success) #}
                        <td class="{% if 帳差 < 0 %}text-danger{% elif 帳差 > 0 %}text-primary{% else %}text-success{% endif %}">
                            帳差 (B - A)
                        </td>
                        <td class="text-end {% if 帳差 < 0 %}text-danger{% elif 帳差 > 0 %}text-primary{% else %}text-success{% endif %}"
                            style="width: 1rem;">
                            $
                        </td>
                        <td class="text-end {% if 帳差 < 0 %}text-danger{% elif 帳差 > 0 %}text-primary{% else %}text-success{% endif %}"
                            style="width: 10ch;">
                            {{ 帳差 | round(2) | int }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{# --- 業績統計卡片 --- #}
<div class="card mt-4">
    <div class="card-header fs-5">業績統計</div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center fs-5">
                交易筆數 (顧客總數)
                <span class="badge bg-primary rounded-pill fs-6">{{ day.total_transactions }} 筆</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center fs-5">
                銷售件數 (商品總數)
                <span class="badge bg-primary rounded-pill fs-6">{{ day.total_items }} 件</span>
            </li>
        </ul>
    </div>
</div>

{# --- 簽核欄卡片 --- #}
<div class="card mt-4">
    <div class="card-header fs-5">簽核欄</div>
    <div class="card-body">
        <div class="row text-center">
            {# 使用 Bootstrap 的網格系統。col-12 表示在最小的螢幕上佔滿12欄 (即一整行)，col-md-4 表示在中等螢幕以上佔4欄 (即一行三個) #}
            <div class="col-12 col-md-4 mb-3">
                <label class="form-label">作業員</label>
                {# 每個簽核區都包含一個 canvas (手寫板) 和一個 input (打字輸入框)，透過 JS 切換顯示 #}
                <div class="signature-container border rounded"><canvas class="signature-canvas"></canvas><input
                        type="text" class="form-control signature-input" style="display:none;"
                        placeholder="請在此輸入姓名"></div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-secondary toggle-btn">切換打字</button>
                    <button type="button" class="btn btn-sm btn-outline-danger clear-btn">清除</button>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <label class="form-label">覆核員</label>
                <div class="signature-container border rounded"><canvas class="signature-canvas"></canvas><input
                        type="text" class="form-control signature-input" style="display:none;"
                        placeholder="請在此輸入姓名"></div>
                <div class="mt-2"><button type="button"
                        class="btn btn-sm btn-secondary toggle-btn">切換打字</button><button type="button"
                        class="btn btn-sm btn-outline-danger clear-btn">清除</button></div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <label class="form-label">出納員</label>
                <div class="signature-container border rounded"><canvas class="signature-canvas"></canvas><input
                        type="text" class="form-control signature-input" style="display:none;"
                        placeholder="請在此輸入姓名"></div>
                <div class="mt-2"><button type="button"
                        class="btn btn-sm btn-secondary toggle-btn">切換打字</button><button type="button"
                        class="btn btn-sm btn-outline-danger clear-btn">清除</button></div>
            </div>
        </div>
    </div>
</div>

{% if day.status != 'CLOSED' %}
    {# --- [關鍵修正] --- #}
    {# 將 action="" 修改為指向正確的 confirm_report 路由 #}
    <form method="POST" action="{{ url_for('cashier.confirm_report', location_slug=(day.location.slug or day.location)) }}" novalidate
        onsubmit="return confirm('請注意：確認後本日所有帳務將被鎖定，無法再進行任何修改。確定要結束本日營業嗎？');">
        
        {# 插入 CSRF token，這是解決問題的核心 #}
        {{ form.hidden_tag() }}

        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-success btn-lg">確認存檔並結束本日營業</button>
        </div>
    </form>
{% else %}
    <div class="alert alert-info mt-4 text-center" role="alert">
        本日帳務已於 {{ day.updated_at.strftime('%Y-%m-%d %H:%M') }} 歸檔，僅供查閱。<br>
        <a href="{{ url_for('cashier.dashboard') }}" class="btn btn-primary mt-2">返回儀表板</a>
    </div>
{% endif %}

{# 這裡的 <style> 標籤是專屬於此頁面的，將它放在 content 區塊的末尾是安全的 #}
<style>
    .signature-container {
        position: relative;
        width: 100%;
        height: 150px;
    }
    .signature-canvas {
        display: block;
        width: 100%;
        height: 150px;
        cursor: crosshair;
    }
    .signature-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        font-size: 2rem;
        text-align: center;
        border: none;
        background-color: transparent;
    }
</style>
{% endblock %}


{% block scripts %}
{# 引入外部的 signature_pad.js 函式庫，這是實現手寫簽名功能的核心 #}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const signatureContainers = document.querySelectorAll('.signature-container');
        signatureContainers.forEach(container => {
            const canvas = container.querySelector('.signature-canvas');
            const input = container.querySelector('.signature-input');
            const toggleBtn = container.parentElement.querySelector('.toggle-btn');
            const clearBtn = container.parentElement.querySelector('.clear-btn');
            const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            clearBtn.addEventListener('click', () => {
                if (canvas.style.display !== 'none') { signaturePad.clear(); } else { input.value = ''; }
            });
            toggleBtn.addEventListener('click', () => {
                const isCanvasVisible = canvas.style.display !== 'none';
                if (isCanvasVisible) {
                    canvas.style.display = 'none';
                    input.style.display = 'block';
                    toggleBtn.innerText = '切換簽名';
                } else {
                    canvas.style.display = 'block';
                    input.style.display = 'none';
                    toggleBtn.innerText = '切換打字';
                    resizeCanvas();
                }
            });
        });
    });
</script>
{% endblock %}
