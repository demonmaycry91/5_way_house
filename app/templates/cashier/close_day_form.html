{% extends "base.html" %}
{% from "macros.html" import page_header with context %}

{% block title %}日結作業 - 現金盤點{% endblock %}

{% block content %}
{{ page_header(
    title='日結作業', 
    subtitle='據點：' ~ location ~ ' | 日期：' ~ today_date, 
    button_url=url_for('cashier.dashboard'), 
    button_text='返回儀表板'
    ) }}

<div class="card">
    <div class="card-body">
        <form method="POST" action="" novalidate>
            {# 這是最重要的部分：插入 CSRF token #}
            {{ form.hidden_tag() }}
            <table class="table table-borderless">
                <thead>
                    <tr>
                        <th style="width: 25%;">面額</th>
                        <th style="width: 35%;">數量</th>
                        <th class="text-end" style="width: 40%;">小計</th>
                    </tr>
                </thead>
                <tbody>
                    {% for denom in denominations %}
                    <tr>
                        <td class="align-middle">NT$ {{ denom }}</td>
                        <td>
                            {# --- ↓↓↓ 主要修改點在這裡 ↓↓↓ --- #}
                            <input type="number" class="form-control form-control-lg text-center"
                                name="count_{{ denom }}" min="0" value="0" data-value="{{ denom }}"
                                oninput="updateSubtotal(this)" onfocus="handleFocus(this)"
                                onblur="handleBlur(this)">
                            {# --- ↑↑↑ 修改結束 ↑↑↑ --- #}
                        </td>
                        <td class="align-middle text-end fs-5" id="subtotal_{{ denom }}">
                            $0
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">盤點總額:</h3>
                <h3 class="mb-0" id="grand-total">$0</h3>
            </div>
            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg">送出盤點結果並預覽報表</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- ↓↓↓ 請用這段新的 script 替換掉舊的 script ↓↓↓ ---

    // 當使用者點擊輸入框時
    function handleFocus(element) {
        if (element.value === '0') {
            element.value = '';
        }
    }

    // 當使用者離開輸入框時
    function handleBlur(element) {
        if (element.value === '') {
            element.value = '0';
        }
        // 確保即使在 blur 事件後，總計也能更新
        updateGrandTotal();
    }

    function updateSubtotal(element) {
        const count = parseInt(element.value) || 0;
        const value = parseInt(element.dataset.value);
        const subtotal = count * value;
        document.getElementById(`subtotal_${value}`).innerText = `$${subtotal.toLocaleString()}`;
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let grandTotal = 0;
        const inputs = document.querySelectorAll('input[data-value]');
        inputs.forEach(input => {
            const count = parseInt(input.value) || 0;
            const value = parseInt(input.dataset.value);
            grandTotal += count * value;
        });
        document.getElementById('grand-total').innerText = `$${grandTotal.toLocaleString()}`;
    }

    // --- ↑↑↑ 替換結束 ↑↑↑ ---
</script>
{% endblock %}