{% extends "base.html" %}
{% from "macros.html" import page_header with context %}

{% block title %}報表查詢{% endblock %}

{% block content %}
{{ page_header(title='報表查詢', subtitle='請選擇您想查詢的報表類型與條件') }}

<div class="card mb-4">
    <div class="card-body">
        <form method="POST" action="" class="row g-3 align-items-end" novalidate>
            {{ form.hidden_tag() }}

            <div class="col-md-3">
                {{ form.report_type.label(class="form-label") }}
                {{ form.report_type(class="form-select", id="reportTypeSelect") }}
            </div>
            <div class="col-md-3" id="locationSelectContainer">
                {{ form.location_id.label(class="form-label") }}
                {{ form.location_id(class="form-select") }}
            </div>
            <div class="col-md-3">
                {{ form.start_date.label(class="form-label") }}
                {{ form.start_date(class="form-control") }}
            </div>
            <div class="col-md-3 d-grid align-self-stretch" id="endDateContainer" style="display: none;">
                {# 結束日期欄位預設隱藏，由 JS 控制 #}
                {{ form.end_date.label(class="form-label") }}
                {{ form.end_date(class="form-control") }}
            </div>
            <div class="col-md-3 d-grid align-self-stretch">
                {{ form.submit(class="btn btn-primary w-100") }}
            </div>
        </form>
    </div>
</div>

{% if results is not none %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">查詢結果</h5>
    </div>
    <div class="card-body">
        {# ... (daily_summary, transaction_log, daily_cash_summary 的顯示區塊維持不變) ... #}
        {% if report_type == 'daily_summary' %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>據點</th>
                            <th class="text-end">開店金</th>
                            <th class="text-end">銷售總額</th>
                            <th class="text-end">帳面總額</th>
                            <th class="text-end">盤點現金</th>
                            <th class="text-end">帳差</th>
                            <th class="text-center">交易筆數</th>
                            <th class="text-center">銷售件數</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in results %}
                        <tr>
                            <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ day.location.name }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.opening_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.total_sales) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.expected_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.closing_cash) }}</td>
                            <td class="text-end {% if day.cash_diff < 0 %}text-danger{% endif %}">${{ "{:,.0f}".format(day.cash_diff) }}</td>
                            <td class="text-center">{{ day.total_transactions }}</td>
                            <td class="text-center">{{ day.total_items }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">查無資料</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'transaction_log' %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>時間</th>
                            <th>據點</th>
                            <th>項目/折扣</th>
                            <th>類型</th>
                            <th class="text-end">單價/折扣額</th>
                            <th class="text-end">交易總額</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in results %}
                        {% for item in transaction.items %}
                        <tr>
                            {% if loop.first %}
                            <td rowspan="{{ transaction.items | length }}">{{ transaction.timestamp.strftime('%H:%M:%S') }}</td>
                            <td rowspan="{{ transaction.items | length }}">{{ transaction.business_day.location.name }}</td>
                            {% endif %}
                            <td>{{ item.category.name if item.category else '手動輸入' }}</td>
                            <td><span class="badge {{ 'bg-success' if item.price > 0 else 'bg-danger' }}">{{ '商品' if item.price > 0 else '折扣' }}</span></td>
                            <td class="text-end">${{ "{:,.0f}".format(item.price) }}</td>
                            {% if loop.first %}
                            <td rowspan="{{ transaction.items | length }}" class="text-end fw-bold">${{ "{:,.0f}".format(transaction.amount) }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center">找不到任何交易紀錄。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'daily_cash_summary' %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>據點</th>
                            <th class="text-end">開店現金</th>
                            <th class="text-end">手帳營收</th>
                            <th class="text-end">應有現金</th>
                            <th class="text-end">實有現金</th>
                            <th class="text-end">溢短收</th>
                            <th class="text-end">捐款</th>
                            <th class="text-end">其他收入</th>
                            <th class="text-end">其他現金(總)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if results %}
                        <tr class="fw-bold table-secondary">
                            <td>總計</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.opening_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.total_sales) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.expected_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.closing_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.cash_diff) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.donation_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.other_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.other_cash) }}</td>
                        </tr>
                        {% for day in results %}
                        <tr>
                            <td>{{ day.location.name }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.opening_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.total_sales) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.expected_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.closing_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.cash_diff) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.donation_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.other_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format((day.donation_total or 0) + (day.other_total or 0)) }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">查無資料</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

        <!-- --- ↓↓↓ 在這裡新增合併報表總結的顯示區塊 ↓↓↓ --- -->
        {% elif report_type == 'combined_summary_final' %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover" style="font-size: 0.9rem;">
                    <thead class="table-light align-middle text-center">
                        <tr>
                            <th rowspan="2">項目</th>
                            <th rowspan="2">計算/填入方式</th>
                            <th rowspan="2">總計</th>
                            {% for detail in results %}
                                <th colspan="2">{{ detail.location_name }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            {% for detail in results %}
                                <th>手帳登錄</th>
                                <th>備註</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>A - 應有現金</strong></td>
                            <td>B + C</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.a) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.a) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>B - 手帳營收</strong></td>
                            <td>帶入</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.b) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.b) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>C - 開店現金</strong></td>
                            <td>帶入</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.c) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.c) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>D - 實有現金</strong></td>
                            <td>帶入</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.d) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.d) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>E - 溢短收</strong></td>
                            <td>D - A</td>
                            <td class="text-end fw-bold {% if grand_total.e < 0 %}text-danger{% endif %}">${{ "{:,.0f}".format(grand_total.e) }}</td>
                            {% for detail in results %}
                                <td class="text-end {% if detail.e < 0 %}text-danger{% endif %}">${{ "{:,.0f}".format(detail.e) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>F - 其他現金</strong></td>
                            <td>捐款+其他</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.f) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.f) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>G - 當日總現金</strong></td>
                            <td>D + F</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.g) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.g) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                         <tr>
                            <td><strong>H - 存款</strong></td>
                            <td>G - I</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.h) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.h) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>I - 明日開店現金</strong></td>
                            <td>手動填入</td>
                            <td class="text-end fw-bold">${{ "{:,.0f}".format(grand_total.i) }}</td>
                            {% for detail in results %}
                                <td class="text-end">${{ "{:,.0f}".format(detail.i) }}</td>
                                <td></td>
                            {% endfor %}
                        </tr>
                        <tr class="table-secondary">
                            <td><strong>J - 現金核對</strong></td>
                            <td colspan="2">昨日(I) vs 今日(C)</td>
                            {% for detail in results %}
                                <td class="text-center">
                                    <span class="badge {{ 'bg-success' if detail.j_status == '相符' else ('bg-danger' if detail.j_status == '不符' else 'bg-secondary') }}">
                                        {{ detail.j_status }}
                                    </span>
                                </td>
                                <td class="text-end {% if detail.j_diff != 0 %}text-danger fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(detail.j_diff) if detail.j_status == '不符' else '' }}
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        <!-- --- ↑↑↑ 新增結束 ↑↑↑ --- -->
            
        {% else %}
            <p class="text-center text-muted">請選擇查詢條件以產生報表。</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('reportTypeSelect');
    const locationSelectContainer = document.getElementById('locationSelectContainer');
    const endDateContainer = document.getElementById('endDateContainer');
    const startDateLabel = document.querySelector('label[for="start_date"]');

    function toggleFormFields() {
        const selectedType = reportTypeSelect.value;

        // 據點選擇器
        if (selectedType === 'combined_summary_final') {
            locationSelectContainer.style.display = 'none';
        } else {
            locationSelectContainer.style.display = 'block';
        }

        // 日期選擇器
        if (selectedType === 'transaction_log' || selectedType === 'daily_cash_summary' || selectedType === 'combined_summary_final') {
            endDateContainer.style.display = 'none';
            startDateLabel.textContent = '查詢日期';
        } else {
            endDateContainer.style.display = 'block';
            startDateLabel.textContent = '開始日期';
        }
    }

    reportTypeSelect.addEventListener('change', toggleFormFields);
    toggleFormFields();
});
</script>
{% endblock %}

