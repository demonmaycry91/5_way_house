{% extends "base.html" %}
{% from "macros.html" import page_header with context %}

{% block title %}報表查詢{% endblock %}

{% block styles %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .flatpickr-day .day-status-dot {
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }
    .dot-ready { background-color: #198754; }
    .dot-in-progress { background-color: #ffc107; }
    .dot-no-data { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
{{ page_header(title='報表查詢', subtitle='請選擇您想查詢的報表類型與條件') }}

<div class="card mb-4">
    <div class="card-body">
        <form method="POST" action="" class="row g-3 align-items-end" novalidate>
            {{ form.hidden_tag() }}

            <div class="col-md-3">
                {{ form.report_type.label(class="form-label") }}
                {{ form.report_type(class="form-select", id="reportTypeSelect") }}
            </div>
            <div class="col-md-3">
                {{ form.location_id.label(class="form-label") }}
                {{ form.location_id(class="form-select", id="locationSelect") }}
            </div>
            <div class="col-md-2">
                {{ form.start_date.label(class="form-label") }}
                {{ form.start_date(class="form-control", id="startDatePicker") }}
            </div>
            <div class="col-md-2">
                {{ form.end_date.label(class="form-label") }}
                {{ form.end_date(class="form-control", id="endDatePicker") }}
            </div>
            <div class="col-md-2 d-grid align-self-end">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

{% if results is not none %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">查詢結果</h5>
    </div>
    <div class="card-body">
        {% if report_type == 'daily_summary' %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <colgroup>
                        <col style="width: 15%;">
                        <col style="width: 12%;">
                        <col span="7">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>據點</th>
                            <th class="text-end">開店金</th>
                            <th class="text-end">銷售總額</th>
                            <th class="text-end">帳面總額</th>
                            <th class="text-end">盤點現金</th>
                            <th class="text-end">帳差</th>
                            <th class="text-center">交易筆數</th>
                            <th class="text-center">銷售件數</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in results %}
                        <tr class="{{ 'table-warning' if day.status != 'CLOSED' }}">
                            <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ day.location.name }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.opening_cash or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.total_sales or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.expected_cash or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.closing_cash or 0) }}</td>
                            <td class="text-end {% if day.cash_diff is not none and day.cash_diff < 0 %}text-danger{% endif %}">${{ "{:,.0f}".format(day.cash_diff or 0) }}</td>
                            <td class="text-center">{{ day.total_transactions or 0 }}</td>
                            <td class="text-center">{{ day.total_items or 0 }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">查無資料</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'transaction_log' %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    {# --- ↓↓↓ 在這裡修改欄位寬度與表頭 ↓↓↓ --- #}
                    <colgroup>
                        <col style="width: 15%;">
                        <col style="width: 12%;">
                        <col>
                        <col style="width: 8%;">
                        <col style="width: 12%;">
                        <col style="width: 12%;">
                        <col style="width: 12%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>時間</th>
                            <th>據點</th>
                            <th>項目/折扣</th>
                            <th>類型</th>
                            <th class="text-end">單價/折扣額</th>
                            <th class="text-end">收到現金</th>
                            <th class="text-end">交易總額</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in results %}
                        {% for item in transaction.items %}
                        <tr class="{{ 'table-warning' if transaction.business_day.status != 'CLOSED' }}">
                            {% if loop.first %}
                            <td rowspan="{{ transaction.items | length }}">{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td rowspan="{{ transaction.items | length }}">{{ transaction.business_day.location.name }}</td>
                            {% endif %}
                            <td>{{ item.category.name if item.category else '手動輸入' }}</td>
                            <td><span class="badge {{ 'bg-success' if item.price > 0 else 'bg-danger' }}">{{ '商品' if item.price > 0 else '折扣' }}</span></td>
                            <td class="text-end">${{ "{:,.0f}".format(item.price) }}</td>
                            {% if loop.first %}
                            <td rowspan="{{ transaction.items | length }}" class="text-end">${{ "{:,.0f}".format(transaction.cash_received or 0) }}</td>
                            <td rowspan="{{ transaction.items | length }}" class="text-end fw-bold">${{ "{:,.0f}".format(transaction.amount) }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">找不到任何交易紀錄。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif report_type == 'daily_cash_summary' %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <colgroup>
                        <col style="width: 15%;">
                        <col style="width: 12%;">
                        <col span="8">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>據點</th>
                            <th class="text-end">開店現金</th>
                            <th class="text-end">手帳營收</th>
                            <th class="text-end">應有現金</th>
                            <th class="text-end">實有現金</th>
                            <th class="text-end">溢短收</th>
                            <th class="text-end">捐款</th>
                            <th class="text-end">其他收入</th>
                            <th class="text-end">其他現金(總)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if results %}
                        <tr class="fw-bold table-secondary">
                            <td colspan="2">總計 ({{ form.start_date.data.strftime('%Y-%m-%d') }}{% if form.end_date.data and form.end_date.data != form.start_date.data %} - {{ form.end_date.data.strftime('%Y-%m-%d') }}{% endif %})</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.opening_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.total_sales) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.expected_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.closing_cash) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.cash_diff) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.donation_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.other_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(grand_total.other_cash) }}</td>
                        </tr>
                        {% for day in results %}
                        <tr class="{{ 'table-warning' if day.status != 'CLOSED' }}">
                            <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ day.location.name }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.opening_cash or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.total_sales or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.expected_cash or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.closing_cash or 0) }}</td>
                            <td class="text-end {% if day.cash_diff is not none and day.cash_diff < 0 %}text-danger{% endif %}">${{ "{:,.0f}".format(day.cash_diff or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.donation_total or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day.other_total or 0) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format((day.donation_total or 0) + (day.other_total or 0)) }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">查無資料</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
        {% elif report_type == 'combined_summary_final' %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <colgroup>
                        <col style="width: 15%;">
                        <col span="3">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th class="text-end">昨日預留總額 (I)</th>
                            <th class="text-end">今日開店總額 (C)</th>
                            <th class="text-end">核對結果 (差異)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day_check in results %}
                        <tr class="{{ 'table-danger' if day_check.cash_check_diff != 0 }}">
                            <td>{{ day_check.date.strftime('%Y-%m-%d') }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day_check.yesterday_total) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(day_check.today_total) }}</td>
                            <td class="text-end {% if day_check.cash_check_diff != 0 %}fw-bold{% endif %}">
                                {% if day_check.cash_check_diff == 0 %}
                                    相符
                                {% else %}
                                    ${{ "{:,.0f}".format(day_check.cash_check_diff) }}
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">查無核對資料</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}
            <p class="text-center text-muted">請選擇查詢條件以產生報表。</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Flatpickr 台灣中文語系 -->
<script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('reportTypeSelect');
    const locationSelect = document.getElementById('locationSelect');

    function toggleLocationSelect() {
        const selectedType = reportTypeSelect.value;
        if (selectedType === 'combined_summary_final') {
            locationSelect.disabled = true;
            locationSelect.value = 'all'; 
        } else {
            locationSelect.disabled = false;
        }
    }

    reportTypeSelect.addEventListener('change', toggleLocationSelect);
    toggleLocationSelect();

    let dateStatusCache = {};

    function fetchDateStatus(instance, callback) {
        const year = instance.currentYear;
        const month = instance.currentMonth + 1;
        const cacheKey = `${year}-${month}`;

        if (dateStatusCache[cacheKey]) {
            if (callback) callback();
            return;
        }

        fetch(`{{ url_for('report.query_status_api') }}?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                dateStatusCache[cacheKey] = data;
                if (callback) callback();
            });
    }
    
    const flatpickrConfig = {
        locale: "zh_tw",
        dateFormat: "Y-m-d",
        onReady: function(selectedDates, dateStr, instance) {
            fetchDateStatus(instance, () => instance.redraw());
        },
        onMonthChange: function(selectedDates, dateStr, instance) {
            fetchDateStatus(instance, () => instance.redraw());
        },
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const year = dayElem.dateObj.getFullYear();
            const month = dayElem.dateObj.getMonth() + 1;
            const cacheKey = `${year}-${month}`;
            
            const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(dayElem.dateObj.getDate()).padStart(2, '0')}`;
            
            const statusData = dateStatusCache[cacheKey];
            if (statusData && statusData[isoDate]) {
                const status = statusData[isoDate];
                const dot = document.createElement('span');
                dot.className = `day-status-dot dot-${status.replace('_', '-')}`;
                dayElem.appendChild(dot);
            }
        }
    };

    const fp_start = flatpickr("#startDatePicker", {
        ...flatpickrConfig,
        defaultDate: "{{ form.start_date.data.isoformat() if form.start_date.data else 'today' }}"
    });
    
    const fp_end = flatpickr("#endDatePicker", {
        ...flatpickrConfig,
        defaultDate: "{{ form.end_date.data.isoformat() if form.end_date.data else '' }}"
    });
});
</script>
{% endblock %}

